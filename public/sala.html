<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SALA PRINCIPAL</title>
  <link rel="stylesheet" href="style.css" />
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <div class="container">
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h2>Usuários</h2>
        <button class="close-sidebar" onclick="toggleSidebar()">×</button>
      </div>
      <ul id="usuariosOnline"></ul>
    </aside>

    <main class="chat">
      <header class="chat-header">
        <h1>SALA PRINCIPAL</h1>
        <button class="mobile-toggle" onclick="toggleSidebar()">☰</button>
      </header>

      <ul id="mural" class="mural"></ul>

      <form id="formMensagem" class="chat-form">
        <input type="text" id="mensagem" placeholder="Digite uma mensagem..." autocomplete="off" />
        <input type="file" id="imagemInput" accept="image/*" hidden />
        <button type="button" onclick="document.getElementById('imagemInput').click()">📷</button>
        <button type="button" id="audioBtn">🎤</button>
        <button type="submit">Enviar</button>
      </form>
    </main>
  </div>

  <script>
    const socket = io();
    const params = new URLSearchParams(window.location.search);
    const username = params.get("username") || "Anônimo";

    const mural = document.getElementById("mural");
    const form = document.getElementById("formMensagem");
    const input = document.getElementById("mensagem");
    const imagemInput = document.getElementById("imagemInput");
    const usuariosOnline = document.getElementById("usuariosOnline");

    socket.emit("entrar", username);

    form.addEventListener("submit", e => {
      e.preventDefault();
      const texto = input.value.trim();
      if (texto) {
        socket.emit("mensagem", { username, text: texto });
        input.value = "";
      }
    });

    socket.on("mensagem", data => {
      const li = document.createElement("li");
      li.innerHTML = `<strong class="user-name" onclick="mencionar('${data.username}')">${data.username}</strong>: ${data.text}`;
      mural.appendChild(li);
      mural.scrollTop = mural.scrollHeight;
    });

    socket.on("usuarios", usuarios => {
      usuariosOnline.innerHTML = "";
      usuarios.forEach(nome => {
        const li = document.createElement("li");
        li.textContent = nome;
        li.onclick = () => mencionar(nome);
        usuariosOnline.appendChild(li);
      });
    });

    function mencionar(nome) {
      input.value += `@${nome} `;
      input.focus();
    }

    function toggleSidebar() {
      document.getElementById("sidebar").classList.toggle("visible");
    }

    imagemInput.addEventListener("change", () => {
      const file = imagemInput.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = () => {
        const imgId = `img-${Date.now()}`;
        socket.emit("mensagem", {
          username,
          text: `
            <div class="image-container">
              <button onclick="document.getElementById('${imgId}').style.display='block'; this.style.display='none'; this.nextElementSibling.style.display='inline-block';">Ver imagem</button>
              <button style="display:none;" onclick="document.getElementById('${imgId}').style.display='none'; this.style.display='none'; this.previousElementSibling.style.display='inline-block';">Ocultar imagem</button>
              <img id="${imgId}" src="${reader.result}" class="chat-img" style="display:none;" />
            </div>
          `
        });
      };
      reader.readAsDataURL(file);
    });

    // Áudio (até 1 minuto)
    const audioBtn = document.getElementById("audioBtn");
    let mediaRecorder;
    let chunks = [];

    audioBtn.addEventListener("click", () => {
      if (!mediaRecorder || mediaRecorder.state === "inactive") {
        navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
          mediaRecorder = new MediaRecorder(stream);
          mediaRecorder.start();

          audioBtn.textContent = "■";

          mediaRecorder.ondataavailable = e => chunks.push(e.data);
          mediaRecorder.onstop = () => {
            const blob = new Blob(chunks, { type: "audio/webm" });
            chunks = [];
            const reader = new FileReader();
            reader.onloadend = () => {
              socket.emit("mensagem", {
                username,
                text: `<audio controls src="${reader.result}"></audio>`
              });
            };
            reader.readAsDataURL(blob);
            audioBtn.textContent = "🎤";
          };

          setTimeout(() => {
            if (mediaRecorder && mediaRecorder.state === "recording") {
              mediaRecorder.stop();
            }
          }, 60000);
        });
      } else if (mediaRecorder.state === "recording") {
        mediaRecorder.stop();
      }
    });
  </script>
</body>
</html>
