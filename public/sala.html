<!DOCTYPE html><html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sala Global</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background-color: #1e1e1e;
      color: white;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      background-color: #2a2a2a;
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #chat {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
    }
    #usuarios {
      background: #333;
      padding: 1rem;
      height: 100%;
      width: 200px;
    }
    #mensagem-form {
      display: flex;
      padding: 1rem;
      gap: 0.5rem;
      background: #2a2a2a;
    }
    #mensagem-input {
      flex: 1;
      padding: 0.5rem;
      font-size: 1rem;
    }
    button, .icon-button {
      background: #4caf50;
      border: none;
      color: white;
      padding: 0.5rem 0.75rem;
      font-size: 1rem;
      cursor: pointer;
      border-radius: 4px;
    }
    .icon-button {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .hidden { display: none; }
    .mobile-users-toggle {
      display: none;
      margin-left: 1rem;
    }
    @media (max-width: 768px) {
      #usuarios {
        position: absolute;
        top: 0;
        right: 0;
        width: 250px;
        height: 100vh;
        background: #2a2a2a;
        z-index: 999;
        display: none;
      }
      .mobile-users-toggle {
        display: inline-block;
      }
    }
  </style>
</head>
<body>
  <header>
    <h2>Sala Global</h2>
    <button class="mobile-users-toggle" onclick="toggleUsuarios()">Usuários</button>
  </header>
  <div style="display: flex; flex: 1;">
    <aside id="usuarios"></aside>
    <main style="flex: 1; display: flex; flex-direction: column;">
      <section id="chat"></section>
      <form id="mensagem-form">
        <input id="mensagem-input" type="text" placeholder="Digite sua mensagem" autocomplete="off" required />
        <input id="imagem-input" type="file" accept="image/*" style="display:none" />
        <button type="button" class="icon-button" onclick="document.getElementById('imagem-input').click()">📷</button>
        <button type="button" class="icon-button" id="audio-btn">🎤</button>
        <button type="submit">Enviar</button>
      </form>
    </main>
  </div>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const chat = document.getElementById('chat');
    const form = document.getElementById('mensagem-form');
    const input = document.getElementById('mensagem-input');
    const imagemInput = document.getElementById('imagem-input');
    const usuarios = document.getElementById('usuarios');
    const audioBtn = document.getElementById('audio-btn');const username = new URLSearchParams(window.location.search).get('username');
socket.emit('entrar', username);

socket.on('usuarios', lista => {
  usuarios.innerHTML = `<h3>Usuários</h3><ul>${lista.map(u => `<li>${u}</li>`).join('')}</ul>`;
});

socket.on('mensagem', data => {
  const el = document.createElement('div');
  if (data.tipo === 'texto') {
    el.textContent = `${data.usuario}: ${data.mensagem}`;
  } else if (data.tipo === 'imagem') {
    el.innerHTML = `${data.usuario}: <img src="${data.url}" style="max-width:200px;">`;
  } else if (data.tipo === 'audio') {
    el.innerHTML = `${data.usuario}: <audio controls src="${data.url}"></audio>`;
  }
  chat.appendChild(el);
  chat.scrollTop = chat.scrollHeight;
});

form.addEventListener('submit', e => {
  e.preventDefault();
  if (input.value.trim()) {
    socket.emit('mensagem', { tipo: 'texto', usuario: username, mensagem: input.value });
    input.value = '';
  }
});

imagemInput.addEventListener('change', () => {
  const file = imagemInput.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = () => {
      socket.emit('mensagem', { tipo: 'imagem', usuario: username, url: reader.result });
    };
    reader.readAsDataURL(file);
  }
});

function toggleUsuarios() {
  usuarios.style.display = usuarios.style.display === 'block' ? 'none' : 'block';
}

// Áudio (60s máximo)
let mediaRecorder, chunks = [];
let recording = false;

audioBtn.addEventListener('mousedown', startRecording);
audioBtn.addEventListener('mouseup', stopRecording);
audioBtn.addEventListener('touchstart', startRecording);
audioBtn.addEventListener('touchend', stopRecording);

function startRecording() {
  if (recording) return;
  recording = true;
  navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
    mediaRecorder = new MediaRecorder(stream);
    mediaRecorder.start();

    chunks = [];
    mediaRecorder.ondataavailable = e => chunks.push(e.data);

    mediaRecorder.onstop = () => {
      const blob = new Blob(chunks, { type: 'audio/ogg; codecs=opus' });
      const reader = new FileReader();
      reader.onloadend = () => {
        socket.emit('mensagem', { tipo: 'audio', usuario: username, url: reader.result });
      };
      reader.readAsDataURL(blob);
    };

    setTimeout(() => {
      if (recording) stopRecording();
    }, 60000); // 60 segundos
  });
}

function stopRecording() {
  if (!recording || !mediaRecorder) return;
  recording = false;
  mediaRecorder.stop();
}

  </script>
</body>
</html>
