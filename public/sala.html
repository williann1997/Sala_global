<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sala Global</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    * {
      margin: 0; padding: 0; box-sizing: border-box;
      font-family: 'Inter', sans-serif;
    }
    body {
      background-color: #1e1e1e;
      color: white;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header {
      background-color: #2a2a2a;
      padding: 1rem;
      text-align: center;
      font-weight: bold;
    }
    #chat-container {
      flex: 1;
      display: flex;
      overflow: hidden;
    }
    #users {
      width: 250px;
      background-color: #2f2f2f;
      padding: 1rem;
      display: flex;
      flex-direction: column;
    }
    #users h3 {
      margin-bottom: 0.5rem;
    }
    #users ul {
      list-style: none;
      overflow-y: auto;
      flex: 1;
    }
    #users li {
      padding: 0.25rem 0;
      border-bottom: 1px solid #444;
    }
    #chat {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 1rem;
      overflow: hidden;
    }
    #mensagens {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 1rem;
    }
    .mensagem {
      margin-bottom: 0.5rem;
      background-color: #333;
      padding: 0.5rem;
      border-radius: 4px;
    }
    .imagem-enviada {
      display: none;
      margin-top: 0.5rem;
      max-width: 100%;
      border-radius: 4px;
    }
    form {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    input[type="text"] {
      flex: 1;
      padding: 0.5rem;
      border-radius: 4px;
      border: none;
    }
    button {
      padding: 0.5rem 1rem;
      background-color: #4caf50;
      border: none;
      border-radius: 4px;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    .icon-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.2rem;
      color: white;
    }
    #toggleUsersBtn {
      display: none;
      background: #444;
      border: none;
      color: white;
      padding: 0.5rem;
      width: 100%;
    }
    @media (max-width: 768px) {
      #users {
        position: absolute;
        z-index: 10;
        left: 0;
        top: 60px;
        bottom: 0;
        display: none;
      }
      #toggleUsersBtn {
        display: block;
      }
    }
  </style>
</head>
<body>
  <header>
    Sala Global
  </header>
  <button id="toggleUsersBtn">Mostrar/Ocultar Usu√°rios</button>
  <div id="chat-container">
    <div id="users">
      <h3>Usu√°rios Online</h3>
      <button onclick="document.getElementById('users').style.display='none'">Fechar</button>
      <ul id="userList"></ul>
    </div>
    <div id="chat">
      <div id="mensagens"></div>
      <form id="formMensagem">
        <input id="mensagem" autocomplete="off" placeholder="Digite uma mensagem..." />
        <label>
          <input type="file" id="imagemInput" accept="image/*" hidden />
          <span class="icon-btn">üñºÔ∏è</span>
        </label>
        <button type="button" id="audioBtn" class="icon-btn">üé§</button>
        <button type="submit">Enviar</button>
      </form>
    </div>
  </div>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const urlParams = new URLSearchParams(window.location.search);
    const username = urlParams.get('username') || 'An√¥nimo';
    const form = document.getElementById('formMensagem');
    const input = document.getElementById('mensagem');
    const mensagens = document.getElementById('mensagens');
    const userList = document.getElementById('userList');
    const imagemInput = document.getElementById('imagemInput');

    socket.emit('usuario_entrando', username);

    socket.on('atualizar_usuarios', usuarios => {
      userList.innerHTML = '';
      usuarios.forEach(nome => {
        const li = document.createElement('li');
        li.textContent = nome;
        userList.appendChild(li);
      });
    });

    socket.on('mensagem', data => {
      const div = document.createElement('div');
      div.classList.add('mensagem');
      div.innerHTML = `<strong>${data.nome}:</strong> ${data.texto || ''}`;
      if (data.imagem) {
        const btn = document.createElement('button');
        btn.textContent = 'Ver imagem';
        btn.onclick = () => {
          img.style.display = img.style.display === 'none' ? 'block' : 'none';
        };
        const img = document.createElement('img');
        img.src = data.imagem;
        img.className = 'imagem-enviada';
        div.appendChild(btn);
        div.appendChild(img);
      }
      mensagens.appendChild(div);
      mensagens.scrollTop = mensagens.scrollHeight;
    });

    form.addEventListener('submit', e => {
      e.preventDefault();
      if (input.value.trim()) {
        socket.emit('mensagem', { nome: username, texto: input.value });
        input.value = '';
      }
    });

    imagemInput.addEventListener('change', () => {
      const file = imagemInput.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = () => {
          socket.emit('mensagem', { nome: username, imagem: reader.result });
        };
        reader.readAsDataURL(file);
      }
    });

    // Bot√£o de √°udio
    const audioBtn = document.getElementById('audioBtn');
    let mediaRecorder;
    let audioChunks = [];
    let gravaTimeout;

    audioBtn.addEventListener('mousedown', async () => {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];
      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      mediaRecorder.onstop = () => {
        const blob = new Blob(audioChunks, { type: 'audio/webm' });
        const reader = new FileReader();
        reader.onloadend = () => {
          socket.emit('mensagem', { nome: username, imagem: reader.result }); // reutilizando campo imagem
        };
        reader.readAsDataURL(blob);
      };
      mediaRecorder.start();
      gravaTimeout = setTimeout(() => mediaRecorder.stop(), 60000);
    });

    audioBtn.addEventListener('mouseup', () => {
      if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
        clearTimeout(gravaTimeout);
      }
    });

    // Toggle usu√°rios mobile
    document.getElementById('toggleUsersBtn').addEventListener('click', () => {
      const usersDiv = document.getElementById('users');
      usersDiv.style.display = usersDiv.style.display === 'block' ? 'none' : 'block';
    });
  </script>
</body>
</html>
